# Руководство по обработке ошибок

## Принципы обработки ошибок

### 1. Когда показывать toast уведомления

**✅ Показывать toast.error:**
- Критические ошибки, которые влияют на пользовательский опыт
- Ошибки при действиях пользователя (создание кампании, пожертвование, обновление профиля)
- Ошибки загрузки данных, которые пользователь ожидает увидеть
- Ошибки валидации форм

**❌ НЕ показывать toast.error:**
- Ошибки при первой загрузке страницы (чтобы не раздражать пользователя)
- Ошибки авторизации (пользователь увидит форму входа)
- Ошибки в фоновых процессах (webhook, cron jobs)
- Ошибки, которые уже обработаны и показаны другим способом

### 2. Когда только логировать в консоль

**✅ Только console.error:**
- Ошибки в серверных компонентах (Next.js Server Components)
- Ошибки в API routes (возвращаем JSON с ошибкой)
- Ошибки в фоновых задачах
- Ошибки, которые не критичны для пользователя

### 3. Примеры правильной обработки

#### Клиентский компонент с действием пользователя
```typescript
try {
  const result = await createCampaign(data)
  if (result.error) {
    toast.error(result.error) // ✅ Показываем пользователю
    return
  }
  toast.success("Кампания создана!")
} catch (error) {
  console.error("Unexpected error:", error) // Логируем для разработчика
  toast.error("Произошла ошибка. Попробуйте снова.") // ✅ Показываем пользователю
}
```

#### Загрузка данных при первой загрузке
```typescript
useEffect(() => {
  async function loadData() {
    try {
      const result = await fetchData()
      if (result.error) {
        console.error("Error loading data:", result.error)
        // ❌ НЕ показываем toast - пользователь увидит пустой список
        setData([])
        return
      }
      setData(result.data)
    } catch (error) {
      console.error("Failed to load:", error)
      // ❌ НЕ показываем toast при первой загрузке
      setData([])
    }
  }
  loadData()
}, [])
```

#### Обновление данных по действию пользователя
```typescript
const handleRefresh = async () => {
  try {
    const result = await fetchData()
    if (result.error) {
      toast.error("Не удалось обновить данные") // ✅ Показываем
      return
    }
    toast.success("Обновлено") // ✅ Показываем успех
    setData(result.data)
  } catch (error) {
    console.error("Refresh error:", error)
    toast.error("Ошибка соединения. Проверьте интернет.") // ✅ Показываем
  }
}
```

## Текущее состояние обработки ошибок

### ✅ Хорошо обработано:
- `components/cloudpayments-button.tsx` - все ошибки показываются через toast
- `app/profile/page.tsx` - ошибки загрузки пожертвований показываются
- `components/bookmark-button.tsx` - ошибки показываются
- `app/subscription/checkout/page.tsx` - ошибки показываются

### ⚠️ Можно улучшить:
- `app/page.tsx` - ошибки при первой загрузке не показываются (это правильно)
- `app/rating/page.tsx` - серверный компонент, ошибки только в консоли (это правильно)
- `app/campaigns/page.tsx` - серверный компонент, ошибки только в консоли (это правильно)

## Рекомендации

1. **Всегда логируйте ошибки** - это помогает в отладке
2. **Показывайте toast только для критичных ошибок** - не перегружайте пользователя уведомлениями
3. **Используйте понятные сообщения** - вместо "Error 500" показывайте "Не удалось загрузить данные"
4. **Различайте типы ошибок** - ошибки авторизации, сетевые ошибки, ошибки валидации требуют разного подхода

